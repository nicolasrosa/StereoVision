%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
% Embasamento Teórico ou Fundamentação Teórica: revisão da literatura dos tópicos que sustentam a ciência e o conhecimento, relativos aos objetivos e aos métodos escolhidos para o desenvolvimento do trabalho.
% Itens como Considerações Iniciais e Finais não são obrigatórios, mas completam muito bem qualquer capítulo.
\chapter{Fundamentos Teóricos}
\label{Revisão Bibliográfica}

A visão estéreo possibilita boa identificação de um espaço tridimensional, visto que sua estrutura permite a triangulação de pontos chaves, assim determinando o seu correto posicionamento. Deste modo, compreende-se o porquê deste sistema visual ser amplamente difundido na evolução humana e animal. Em visão computacional, deseja-se emular os sistemas de visão mais eficientes para identificação de objetos e reconhecimento de ambientes. Este processo pode ser realizado  computacionalmente, porém alguns conceitos como: Triangulação, Geometria Epipolar, Calibração e Retificação e Correspondência Estéreo. Estes conceitos encontram-se apresentados nas próximas seções.


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\section{Visão Estéreo - \textit{Stereo Imaging}}
\subsection{Triangulação - \textit{Triangulation}}

Idealmente, a triangulação de um ponto P de coordenadas globais $(X,Y,Z)$ pode ser realizada caso tenha-se uma estrutura estéreo, cujas lentes não apresentem distorção e estejam perfeitamente alinhadas. Deste modo, matematicamente, é possível abstrair os sensores das câmeras como dois planos coplanares entre si. Nessas condições, tem-se que os eixos ópticos das câmeras são paralelos. O eixo óptico, também conhecido como raio principal, é a reta que intercepta o ponto de centro de projeção ${O}$ e o ponto principal da lente ${c}$. Assumindo que as câmeras sejam exatamente iguais e alinhadas, tem-se que os pontos focais da câmera esquerda e da câmera direita são iguais ${f_l = f_r}$ e os pontos principais ${c^{left}_x}$ e  ${c^{right}_x}$ apresentam as mesmas coordenadas \cite{Bradski2008}. A figura \ref{stereo_image_geometric_model} ilustra a representação do modelo idealizado de um sistema estéreo.

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.35]{./Resources/bradski/stereo_image_geometric_model.png}
 	\caption{Modelo Idealizado de um sistema de visão estéreo. Imagem retirada de \cite{Bradski2008}}
 	\label{stereo_image_geometric_model}
\end{figure}

A distância presente entre os pontos $x^l$ e $x^r$ é dada pela equação $d = x^l - x^r$, o valor de $d$ é comumente também de chamado de disparidade. Caso os pontos $x^l$ e $x^r$, a distância focal $f$, a distância entre os centros das câmeras $(T,baseline)$ sejam conhecidos é possível determinar a distância entre o ponto P à base das câmeras $(Z)$. Por meio de semelhanças de triângulos, é possível estabelecer uma relação entre os triângulos $O_lPO_r$ e $x^lPx^r$, a qual está apresentada na equação \ref{triangle_similarity}.

\begin{equation}
\label{triangle_similarity}
\frac{T - (x^l-x^r)}{Z-T} = \frac{T}{Z} \Rightarrow Z = \frac{fT}{(x^l-x^r)} = \frac{fT}{d}
\end{equation}


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Geometria epipolar - \textit{Epipolar Geometry}}

Geometria epipolar corresponde à estrutura básica de um sistema estéreo, na qual leva em consideração os modelos \textit{pinhole} de ambas câmeras utilizadas e encontra-se ilustrada pela figura \ref{geometry_epipolar}. 

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.35]{./Resources/bradski/geometry_epipolar.png}
 	\caption{Geometria Epipolar. Imagem retirada de \cite{Mendes2012}}
 	\label{geometry_epipolar}
\end{figure}

Projeta-se o ponto P no centros de projeção $O^e$ e $O^d$, as linha que interligam o ponto P à esses centros interceptam os planos $\Pi_e$ e $\Pi_d$ nos pontos $p_e$ e $p_d$. Os pontos epipolares (\textit{epipoles}) $e_e$ e $e_d$ estão localizados nos pontos de intersecção da linha que interliga os centros de projeção e os planos projetivos \cite{Mendes2012}. O conhecimento desta geometria é importante pra o entendimento da chamada restrição epipolar (\textit{epipolar constraint}). Esta geometria 

Considerando um sistema estéreo e um certo ponto $P$, deseja-se localizar na imagem da direita o seu ponto homólogo $P'$, isto é, sua projeção no plano projetivo direito. Sem a restrição, faz-se necessário a busca bidimensional em todo espaço do plano $\Pi_d$. Por outro lado, esta restrição garante que o ponto homólogo deve estar sobre a linha epipolar da imagem direita. Deste modo, é possível restringir a busca à uma única dimensão, busca somente sobre a linha epipolar, reduzindo consideravelmente o custo computacional \cite{Bradski2008}. Todavia, o sistema estéreo deve estar corretamente calibrado para que possa tomar mão desta restrição. A expressão \ref{epipolar_constraint} representa a restrição epipolar é dada relação entre a matriz fundamental F e os dois pontos correspondentes, em coordenadas de pixel \cite{RobertLaganiere}.

\begin{equation}
 \label{epipolar_constraint}
 p'^TFp = 0
\end{equation}

Hartley2004


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Calibração das Câmeras- \textit{Calibration}}

Até o presente momento, todos os conceitos apresentados assumiam que as câmeras são idealmente alinhadas e que suas lentes não apresentavam distorção. Na realidade, os centros ópticos não são perfeitamente alinhados e a lente introduz distorções à imagem projetada no sensor da câmera. Deste modo, faz-se necessário o processo de calibração, o qual mensura estas deformidades e estima os parâmetros que consigam anular ou minimizar estas imperfeições. Isso permite que os métodos computacionais obtenham resultados mais coerentes com a realidade.  Estes parâmetros são classificadas em dois tipos específicos: intrínsecos e extrínsecos.


%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Parâmetros intrínsecos}

Correspondem às propriedades intrínsecas de cada câmera, as quais são descritas pela matriz M (\textit{Intrinsic Matrix}) e o vetor D (\textit{Distortion Coefficients Vector}). A figura \ref{lenses_distortion} ilustra o modelo completo, componente radial e componente tangencial do modelo de distorções das lentes da câmera esquerda e direita, respectivamente.
\cite{DevelopmentTeam2016}.

\begin{equation}
 M = \begin{pmatrix}
f_x & 0   & c_x\\ 
  0 & f_y & c_y\\ 
  0 & 0   & 1
\end{pmatrix}
\end{equation}

\begin{center}
  $f_x,f_y$: Distância focal
  
  $c_x,c_y$: Compensação do ponto principal
\end{center}

\begin{equation}
  D = (k_1,k_2,p_1,p_2[,k_3[,k_4,k_5,k_6]])
\end{equation}

\begin{center}
  $k_1,k_2,k_3$: Coeficientes de distorção radial simétrica
  
  $p_1,p_2$: Coeficientes de distorção tangencial (descentrada)
\end{center}

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.20]{./Resources/distortion/lenses_distortion.jpg}
 	\caption{Calibração estéreo dos parâmetros intrínsecos - Modelo de Distorções da câmera esquerda e direita, respectivamente.}
 	\label{lenses_distortion}
\end{figure}


%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Parâmetros extrínsecos}
Correspondem às propriedades extrínsecas, isto é, demonstram a disposição espacial da segunda câmera, direita, com relação à câmera da esquerda em coordenadas globais. Assim como ilustrado na figura \ref{essential_geometry.png}, a matriz de rotação R (3x3) e o vetor de translação T (3x1) são responsáveis por descrever este deslocamento. Geralmente, quando o quadro de referência não encontra-se no centro de projeção da câmera, faz-se necessário a adição da matriz de rotação e o vetor de translação. Neste contexto, utiliza-se o sistema de coordenadas homogêneas, isto é, pontos 2D são representados como vetores 3x1 e pontos 3D como vetores 4x1. Deste modo, tem-se que a equação \ref{projection_equation} descreve a relação do ponto $P(X,Y,Z)$ e o ponto projetado $p'$ no plano $\Pi_r$\cite{RobertLaganiere}.

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{equation}
  s.p' = M
  \begin{bmatrix}
  \begin{array}{c|c}
  R & t
  \end{array}
  \end{bmatrix}
  P 
\end{equation}

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{equation}
\label{projection_equation}
s
\begin{bmatrix}
x \\ 
y \\ 
1 
\end{bmatrix}
= 
\begin{bmatrix}
f_x & 0 & c_x\\ 
0 & f_y & c_y\\ 
0 & 0 & 1
\end{bmatrix} 
\begin{bmatrix}
r_{11} & r_{12} & r_{13} & t_1 \\ 
r_{21} & r_{22} & r_{23} & t_2 \\ 
r_{31} & r_{32} & r_{33} & t_3
\end{bmatrix}
\begin{bmatrix}
X \\ 
Y \\ 
Z \\ 
1
\end{bmatrix}
\end{equation}

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.25]{./Resources/bradski/essential_geometry.png}
 	\caption{O deslocamento do plano $\Pi_r$ com relação ao plano $\Pi_l$ pode ser descrito pela matriz R e o vetor de translação T. Imagem retirada de \cite{Bradski2008}.}
 	\label{essential_geometry.png}
\end{figure}

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Devido ao desalinhamento entre as câmeras, torna-se necessário estimar estas variáveis, aumentando, assim, a eficiência dos métodos estéreo ao procurarem pelas correspondências entre as duas imagens. A figura \ref{stereo_calib_extrinsic}, ilustra o processo de calibração dos parâmetros extrínsecos, no qual utiliza-se um conjunto de imagens do padrão de calibração. Ao fim deste processo, é possível aferir o posicionamento da segunda câmera com relação à primeira\cite{Bouguet1999}.

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.70]{./Resources/stereo_calib_extrinsic.png}
 	\caption{Calibração estéreo dos parâmetros extrínsecos - Estimativa do posicionamento da câmera direita$^2$ em relação à câmera esquerda$^1$.}
 	\label{stereo_calib_extrinsic}
\end{figure}

%----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Retificação das Imagens  - \textit{Rectification}}

O processo de retificação é responsável por realizar as correções com relação à distorção das lentes e ao alinhamento das câmeras, de acordo com os parâmetros obtidos pelo processo de calibração apresentado no tópico anterior. Ao fim deste processo, deseja-se que o par de imagens estéreo estejam retificadas e sem distorções, preparadas para a aplicação dos métodos estéreo, assim como ilustrado na figura \ref{rectification_process}.

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.32]{./Resources/bradski/rectification_process.png}
 	\caption{Retificação de Imagens - Processo de retificação estéreo. Imagem retirada de \cite{Bradski2008}.}
 	\label{rectification_process}
\end{figure}


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Correspondência Estéreo - \textit{Stereo Correspondence}}

Correspondência estéreo não é nada mais que a utilização de métodos estéreo, os quais são responsáveis pela procura de pontos homólogos nos pares de imagens estéreo. Como visto anteriormente, devido ao distanciamento das câmeras $(T)$ e ao distanciamento do objeto com relação às câmeras $(Z)$, o mesmo ponto apresenta diferentes posicionamento nos planos das câmeras $x^l$ e $x^r$. A figura \ref{homologous_points _stereo} ilustra um par de imagens estéreo (esquerda e direita) e o mapa de disparidades gerado pela cena, nas quais os pixeis homólogos estão destacados. Os métodos estéreo utilizam da restrição epipolar o que reduzir o espaço de busca e de diferentes meios para encontrá-los. Mesmo com essa essa restrição e com a retificação das imagens, os métodos ainda assim apresenta um elevado custo computacional, além de que ainda estão sujeitos à encontrarem falsas correspondências. 

\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.33]{./Resources/homologous_points_stereo.png}
 	\caption{Correspondência de pontos homólogos em um par de imagens estéreo. Imagem original retirada de \cite{Scharstein2003}.}
 	\label{homologous_points _stereo}
\end{figure}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Mapa de disparidades - \textit{Disparity Map}}

Como já foi dito anteriormente, disparidade é o deslocamento dos pontos homólogos entre as duas imagens. Nos métodos estéreo, o valor da disparidade é codificada em escala de cinza, a qual é inversamente proporcional à distância do objeto. Portanto, níveis de cinza mais altos (tons claros) correspondem a disparidades maiores (perto) e níveis de cinza mais baixos (tons escuros) correspondem a disparidades mais baixas (distante). Devido a sua relação com a distância, este conceito é comumente atrelado à percepção de profundidade.

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsubsection{Métodos Estéreo}

Abaixo, encontra-se apresentado um pequeno resumo de como são os operadores dos métodos estéreo utilizado neste trabalho.
\begin{enumerate}
 \item \textbf{\textit{Block Matching} - BM:} Este algoritmo é um método local, no qual utiliza soma das diferenças ao quadrado (SSD - \textit{Sum of Squared Differences}) para a determinação de correspondências. O tamanho da vizinhança deve ser avaliado, visto que a densidade do mapa gerado, nível de detalhamento e intensidade de ruído dependem disso. Caso o bloco seja pequeno, o mapa apresentará detalhes mais nítidos, porém adicionará ruídos ao mapa. Por outro lado, um bloco maior reduz o nível de ruído, porém diminui o nível de detalhaento do mapa. As limitações serviram de motivação para a criação do método a seguir \cite{Hirschmuller2008}.   
 \item \textbf{\textit{Semi-global Block Matching} - SGBM:} Este algoritmo é um método global e também visa a obtenção de uma correspondência estéreo mais precisa, para isso, além da etapa de agregação de custo (cálculo da similaridade), modela-se o sistema como um problema de minimização energética \cite{JunhwanKim2003}. Por conta disso, este método é mais lento que o apresentado anterior, porém é mais denso ao comparar-se o nível de detalhamento para um bloco de tamanho pequeno \cite{Hirschmuller2008}.
 
 \item \textbf{\textit{Block Matching with GPU Acceleration} - BMGPU:}
 \end{enumerate}

 

% Remover Depois

% Falar sobre os dois tipos de pesquisa que existem atualmente: fast stereo/high-confidence stereo
% Falar dos melhores methods estereo que existem hj -> http://www.cvlibs.net/datasets/kitti/eval_stereo_flow.php?benchmark=stereo.


% Pegar alguma das referências abaixo
% Métodos Estéreos
% Os métodos estéreos objetivam achar pontos homólogos em um par de imagens estéreo, a Figura
% 2.9 ilustra o problema. Mesmo em imagens retificadas o custo computacional de um método
% estéreo é alto, grande parte dos métodos existentes não são passíveis de serem usados em tempo
% real (Wang et. al., 2006b). Distorção projetiva, oclusão, descontinuidade e ambiguidade são
% alguns dos desafios que estes métodos tem de superar (Mattoccia, 2010). Por contar com tantos
% desafios, este tema é um dos mais investigados da área de visão computacional (Scharstein e
% Szeliski, 2002). Uma revisão geral sobre o tema é apresentada por Scharstein (1999) e Schars-
% tein e Szeliski (2002).


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
%\section{Projeção Tridimensional - \textit{3D Reprojection}}


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
%\section{Reconhecimento de Objeto - \textit{Object Recognition}}
%\subsection{Segmentação - \textit{Image Segmentation}}

%\subsection{Identificação - \textit{Object Identification}}


%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\subsection{Aplicações em Robótica}
\label{aplicacoes_robotica}
Nesta seção, serão apresentados alguns dos trabalhos que têm como principais sensores câmeras estéreo para a navegação autônoma em ambientes terrestre, aérea e subaquática.

Nos dias de hoje, as empresas automobilísticas vem participando de uma verdadeira corrida tecnológica para o desenvolvimento de automóveis totalmente autônomos e economicamente viáveis. As universidades não ficaram para trás e também apresentam pesquisas envolvendo desenvolvimento de algoritmos de controle e sensores, tornando essa corrida ainda mais acirrada. Os resultados apresentados são realmente promissores, o que concretizam cada vez mais essa realidade tida até então como distante. Na figura \ref{caminhao_autonomo}, é possível observar o projeto de caminhão autônomo desenvolvido pelo Laboratório de Robótica Móvel - LRM - ICMC/USP. O caminhão conta com diversos sensores, dentre eles câmeras estéreo, que identificam outros automóveis, pessoas e faixas de sinalização \cite{ShinzatoP}. 

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.35]{./Resources/caminhao_autonomo.jpg}
 	\caption{Caminhão Autônomo desenvolvido pelo Laboratório de Robótica Móvel - LRM - ICMC/USP em parceria com a Scania.}
 	\label{caminhao_autonomo}
\end{figure}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
No caso de navegação autônoma para ambiente aéreo, o projeto utilizando \textit{Micro Air Vehicle} (MAVS) desenvolvido pelo \textit{Massachusetts Institute of Technology} (MIT) permite que estas pequenas aeronaves consigam navegar autonomamente e desviar de obstáculos voando a um velocidade de 30 mph (48 $km/h$). A figura \ref{mit_drones} apresenta o trabalho desenvolvido, o qual é um comparativo de desempenho de uma implementação em hardware utilizando \textit{Field-programmable gate array} (FPGA) e um processador ARM para processamento embarcado do método \textit{Semi-Global Block Matching} (SGBM) \cite{BarryMIT}.

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.30]{./Resources/mit_drones.png}
 	\caption{Plataformas experimentais de aeronaves com o Sistema Estéreo - FPGA (frente) e o Sistema Estéreo - Pushbroom (trás). Câmaras são montados na parte dianteira das asas na mesma linha de base (34 cm) em ambas células.}
 	\label{mit_drones}
\end{figure}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
No caso de navegação autônoma para ambiente subaquático, um exemplo de \textit{autonomous underwater vehicle} (AUV) é o projeto desenvolvido pela Universidade espanhola de Girona (veja figura \ref{G500}). O trabalho propõe a utilização do método de Mapeamento e Localização Simultânea (SLAM), juntamente com câmera estéreo, para o reconhecimento do ambiente, aprimorando assim o erro de rastreamento dos objetos \cite{Nagappa2013}.

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
\begin{figure}[H]
 	\centering
 	\includegraphics[scale=0.1]{./Resources/G500.jpg}
 	\caption{Veículo Submarino Autônomo - Girona 500}
 	\label{G500}
\end{figure}

%-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------